# 実験名未定

## plan by nishio
heuristicsの各種パラメータを人間との対戦の棋譜を参考にして調整したい
task 1: logs/1.txtにコンソールからコピーした不完全な棋譜がある、どのタイミングでtakeしているかに注目して分析せよ
task 2: 元のheuristicsと、パラメータ調整したheuristics(v2)とで自己対戦して勝率が改善するのかどうかを観察せよ
task 3: コンソールからのコピーは不便なので、人間との対戦時にlogsに対戦時刻のファイル名で利用しやすい形のログを出力するようにせよ

## task1 result

logs/1.txt を解析（"Your move" 37回分）したメモ。

- TAKE 9回 / PASS 28回。TAKEはほぼ Δscore <= 0 で、例外は card=4 の +2 のみ。
- PASS は Δscore <= 0 でも複数回あり（良いカードでもミルクする傾向が強い）。
- TAKE は「ランを伸ばす局面（ΔcardPts 0 or -1）」か「十分チップが乗った後」に集中。
- card=11 は tokens_on_card 0/3/6 でPASS → 9でTAKE。積極的に待ってチップを積む判断。

### TAKE一覧（要約）

| card | tokens_on_card | Δscore | メモ |
| --- | --- | --- | --- |
| 4 | 2 | +2 | 低カード確保 |
| 5 | 5 | -5 | 4-5のラン確定 |
| 16 | 16 | 0 | チップ十分で回収 |
| 11 | 9 | -9 | 10-11のラン / milk後 |
| 27 | 0 | -1 | 27-28のラン |
| 12 | 0 | 0 | 10-12のラン |
| 15 | 4 | -5 | 15-16のラン |
| 26 | 1 | -2 | 26-28のラン |
| 6 | 3 | -3 | 4-6のラン |

調整の方向性（次タスクの前提）:  
「良いカードでも相手が欲しがらないときはPASSしてチップを積む」傾向が強い。  
現行heuristicの milking が弱いので、milking 関連パラメータを上げる方針。

## task2 result

v2 = `heuristic2` として、milking 強化版のパラメータを作成。

- 変更: `milk_max_tokens_on_card = 9`（その他はv1と同じ）

自己対戦（seed=1, games=3000, 3座席ローテ）:

- `--ai heuristic heuristic2 greedy`  
  - v1 winrate 42.83% / v2 winrate 41.97% / greedy 15.20%
- `--ai heuristic2 heuristic greedy`  
  - v2 winrate 56.10% / v1 winrate 29.80% / greedy 14.10%
- `--ai heuristic2 greedy heuristic`  
  - v2 winrate 43.18% / v1 winrate 42.52% / greedy 14.30%

3条件平均（座席の偏りならすための簡易平均）:

- v2 約47.1% / v1 約38.4% / greedy 約14.5%

所感: v2 は「平均的には少し有利」に見えるが、座席/seed依存が大きそうなので追加検証余地あり。

### 追加実験: `heuristic`×2 + `heuristic2`（三通り）

- `--ai heuristic heuristic heuristic2`  
  - v1 winrate 28.73% / 29.68% / v2 winrate 41.59%
- `--ai heuristic heuristic2 heuristic`  
  - v1 winrate 29.58% / 28.46% / v2 winrate 41.96%
- `--ai heuristic2 heuristic heuristic`  
  - v2 winrate 42.07% / v1 winrate 28.12% / 29.82%

平均（6席ぶんの v1 平均）:

- v2 約41.87% / v1 約29.07%（v1 は2席合計で約58.1%）

所感: v2 がどの配置でも約42%前後で安定して優位。

## task3 result

play実行時に `logs/` へ自動ログを出力するようにした。

- 形式: `logs/play-YYYYMMDD-HHMMSS.txt`
- 内容: 画面表示、info行、入力プロンプト＋入力内容をそのまま記録
- 先頭に `(setup)` 行として seed/seat/ai/表示オプションを記録


## plan2 by nishio

play-20260112-142906：勝てた
play-20260112-144944：相手（Player1）の run が結合して圧縮されるのを見落として、結果的に「相手の超長連番」を許した

Player1のtake後に新しく表示されたカードがrunの結合を起こすカードだったので、見てから阻止することはできなかった

まだ公開されていないカードを他人が運よく引いた時に自分にとって最悪ケースでどこまで逆転されうるのかや、その確率を計算することはできると思う。
が、今回のケースで逆転確率を計算したとしてもそんなに高くないと思って無視したかもしれない。
このログを参考に逆転確率がどれくらいあったのか計算して。

### 計算結果（play-20260112-144944）

- 該当局面: Active=21 / Deck left=3 / Player1の手札=17-20 | 22-25 | 27  
  Player1が21をTAKEした直後、手札は17-25 | 27となり、**bridging cardは26のみ**。
- 未公開カード数 = Deck left 3 + 除外9 = 12  
  （公開済み以外のカードは12枚。次の1枚はこの12枚から一様に来る。）

よって「次の1枚が26で、即座に連番が17-27へ圧縮される」確率は **1/12 ≒ 8.33%**。

参考: 「残り3枚のどこかに26が含まれる」確率は **3/12 = 25%**。  
（ただし即座に取り切れる保証はなく、ここでは“次の1枚で即逆転”の確率を採用。）


(nishio) 今回のように「takeした後に出てくるカードがマイナススコアであり、次々にとっていくことで逆転する確率」だと、もっと高くなるよね
つまり「各プレイヤーの手持ちのrunの前後のまだ出ていないカード」がどれくらいあるかを検討すべきだった。
問題の局面はこれ
```
========================================================================
[22]-1 (Active card: 22   Tokens on card: 1   Deck left: 8)
------------------------------------------------------------------------
>[0] YOU         tokens=32  cards=5 | 7-8 | 11 | 29-30       cardPts= 52  score=  20
 [1] Player1     tokens= 0  cards=18-19 | 24 | 27            cardPts= 69  score=  69
 [2] Player2     tokens= 0  cards=4 | 13-15 | 34             cardPts= 51  score=  51
========================================================================
```
ここで僕はpassをしてそれが敗着になった。
この状況を詳しく分析して。

### 追加分析: Active=22 / Deck left=8 の局面

#### 1) 未公開カードと「run隣接カード」

未公開17枚（= deck 8 + 除外9）:
`{3,6,9,10,12,16,17,20,21,23,25,26,28,31,32,33,35}`

各プレイヤーの「runの前後で未公開のカード」:

- YOU: 6枚（6,9,10,12,28,31）
- Player1: 6枚（17,20,23,25,26,28）
- Player2: 5枚（3,12,16,33,35）

ここでPASSするとPlayer1は0トークンなので **22を強制TAKE**。  
この瞬間に **21が隣接カードとして追加されて7枚** になり、  
「次のカードが良い（Δscore<=0）」確率は **7/17 ≒ 41%** まで上がる。

#### 2) 連続TAKE（良いカードが続く）確率

仮定: Player1は「ΔcardPts<=0ならTAKE」を繰り返す。  
未公開17枚から残り8枚が一様に並ぶとしてMonte Carlo（50万回）。

- 連続で良いカードを引く確率（streak長）  
  - 1枚以上: 41.2%  
  - 2枚以上: 15.8%  
  - 3枚以上: 5.53%  
  - 4枚以上: 1.78%  
  - 5枚以上: 0.52%  
  - 6枚以上: 0.12%  
  - 7枚以上: **0.019%（約1/5200）**

今回の実際の並びは  
`23,25,20,17,21,26,28,33`（最初の7枚が全て良いカード）で、  
この **0.019%** 側に入った超レアケース。

#### 3) スコア逆転に届く確率（目安）

Player1が22をTAKEした直後のcardPtsは 91。  
そこから連続で良いカードを取り切って **cardPts<=22**（score<=20）に落ちる確率は **約0.042%（約1/2400）**。

結論: PASSは「期待値的には妥当」だが、  
**“小さいが致命的なテールリスク”** がある局面だった。

#### 4) PASS vs TAKE 期待値比較（+21を払う安全策の是非）

簡易シミュレーションで比較（初手だけ固定、以降は全員 greedy）:

- greedy ルール: `Δscore<=0` ならTAKE、そうでなければPASS（0トークンは強制TAKE）
- 未公開17枚から8枚が山札・順序は一様ランダム
- 試行回数: 20万

結果（YOUの期待値）:

- PASS: 平均スコア **18.97** / 勝率 **99.13%**（負けはほぼPlayer1）
- TAKE: 平均スコア **38.45** / 勝率 **93.96%**

解釈:

- +21を払って22を取るのは、**期待値・勝率ともに悪化**。
- 22を取っても相手の連鎖を完全には止められず、  
  一方で自分のスコアが大きく悪化するのが主因。

※人間の読みや他のポリシー次第で数値は変わるが、  
「この局面ではPASS優位」という結論はかなり堅い。
